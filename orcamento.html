<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or√ßamento Mensal - Sistema de Fluxo de Caixa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .saldo-positivo { color: #28a745; }
        .saldo-negativo { color: #dc3545; }
        .card-header { background: linear-gradient(45deg, #007bff, #0056b3); color: white; }
        .btn-receita { background: linear-gradient(45deg, #28a745, #20c997); border: none; }
        .btn-despesa { background: linear-gradient(45deg, #dc3545, #e74c3c); border: none; }
        .btn-orcamento { background: linear-gradient(45deg, #6f42c1, #5a2d91); border: none; }
        .movimento-receita { border-left: 4px solid #28a745; }
        .movimento-despesa { border-left: 4px solid #dc3545; }
        .movimento-orcamento { border-left: 4px solid #6f42c1; }
        
        .header-info {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white !important;
        }
        
        .badge-realizado { background-color: #28a745; }
        .badge-orcado { background-color: #6f42c1; }
        .badge-variacao-positiva { background-color: #28a745; }
        .badge-variacao-negativa { background-color: #dc3545; }
        
        .comparativo-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .comparativo-header {
            background: linear-gradient(45deg, #6f42c1, #5a2d91);
            color: white;
            padding: 10px 15px;
            border-radius: 10px 10px 0 0;
        }
        
        @media (max-width: 768px) {
            .container-fluid { padding: 10px; }
            .card { margin-bottom: 15px; }
            .btn { margin-bottom: 5px; width: 100%; }
            .table-responsive { font-size: 0.9em; }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="header-info d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">üìä Or√ßamento Mensal</h4>
                        <small class="opacity-75">Planeje e acompanhe suas finan√ßas</small>
                    </div>
                    <div>
                        <a href="index.html" class="btn btn-outline-light btn-sm">
                            üí∞ Fluxo de Caixa
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sele√ß√£o de Per√≠odo -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìÖ Per√≠odo de An√°lise</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="anoSelecionado" class="form-label">Ano *</label>
                                <select class="form-select" id="anoSelecionado" required>
                                    <!-- Anos ser√£o preenchidos via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mesSelecionado" class="form-label">M√™s (para cadastro)</label>
                                <select class="form-select" id="mesSelecionado">
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formul√°rios de Lan√ßamento de Or√ßamento -->
        <div class="row">
            <!-- Or√ßamento de Receitas -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Or√ßamento de Receitas</h5>
                    </div>
                    <div class="card-body">
                        <form id="formOrcamentoReceita">
                            <div class="mb-3">
                                <label for="categoriaOrcamentoReceita" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaOrcamentoReceita" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Clientes - Vendas no Espetinho">Clientes - Vendas no Espetinho</option>
                                    <option value="Clientes - Festas">Clientes - Festas</option>
                                    <option value="Clientes - Outras Receitas">Clientes - Outras Receitas</option>
                                    <option value="Dividendos Recebidos">Dividendos Recebidos</option>
                                    <option value="Rendimentos de Aplica√ß√µes">Rendimentos de Aplica√ß√µes</option>
                                    <option value="Devolu√ß√µes de Compra de Mercadoria de Revenda">Devolu√ß√µes de Compra de Mercadoria de Revenda</option>
                                    <option value="Devolu√ß√µes de Compra de Material de Consumo">Devolu√ß√µes de Compra de Material de Consumo</option>
                                    <option value="Devolu√ß√µes de Compra de Mat√©ria Prima">Devolu√ß√µes de Compra de Mat√©ria Prima</option>
                                    <option value="Devolu√ß√µes de Compra de Ativo">Devolu√ß√µes de Compra de Ativo</option>
                                    <option value="Devolu√ß√µes de Compra de Servi√ßos">Devolu√ß√µes de Compra de Servi√ßos</option>
                                    <option value="Adiantamento de Clientes">Adiantamento de Clientes</option>
                                    <option value="Reembolso de Despesas">Reembolso de Despesas</option>
                                    <option value="Empr√©stimos Banc√°rios">Empr√©stimos Banc√°rios</option>
                                    <option value="Venda de Ativos">Venda de Ativos</option>
                                    <option value="Saldo Inicial">Saldo Inicial</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorOrcamentoReceita" class="form-label">Valor Or√ßado (R\$)</label>
                                <input type="number" class="form-control" id="valorOrcamentoReceita" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoOrcamentoReceita" class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="descricaoOrcamentoReceita" rows="2" 
                                          placeholder="Detalhes sobre a previs√£o..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-receita text-white w-100">
                                üí∞ Registrar Or√ßamento de Receita
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Or√ßamento de Despesas -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìâ Or√ßamento de Despesas</h5>
                    </div>
                    <div class="card-body">
                        <form id="formOrcamentoDespesa">
                            <div class="mb-3">
                                <label for="categoriaOrcamentoDespesa" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaOrcamentoDespesa" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Frete - Motoboy">Frete - Motoboy</option>
                                    <option value="Compras Descart√°veis/Embalagens">Compras Descart√°veis/Embalagens</option>
                                    <option value="Compra de Servi√ßos Espetinho">Compra de Servi√ßos Espetinho</option>
                                    <option value="Comiss√µes">Comiss√µes</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Despesas de Viagens">Despesas de Viagens</option>
                                    <option value="Bonifica√ß√µes">Bonifica√ß√µes</option>
                                    <option value="Sal√°rios">Sal√°rios</option>
                                    <option value="Adiantamento">Adiantamento</option>
                                    <option value="F√©rias">F√©rias</option>
                                    <option value="Rescis√µes">Rescis√µes</option>
                                    <option value="13¬∫ Sal√°rio">13¬∫ Sal√°rio</option>
                                    <option value="INSS">INSS</option>
                                    <option value="FGTS">FGTS</option>
                                    <option value="IRRF">IRRF</option>
                                    <option value="Pens√£o Aliment√≠cia">Pens√£o Aliment√≠cia</option>
                                    <option value="Assist√™ncia M√©dica">Assist√™ncia M√©dica</option>
                                    <option value="Vale Transporte">Vale Transporte</option>
                                    <option value="Vale Refei√ß√£o">Vale Refei√ß√£o</option>
                                    <option value="Seguro de Vida">Seguro de Vida</option>
                                    <option value="Outros Benef√≠cios">Outros Benef√≠cios</option>
                                    <option value="Aluguel Espetinho">Aluguel Espetinho</option>
                                    <option value="Energia El√©trica Espetinho">Energia El√©trica Espetinho</option>
                                    <option value="√Ågua Espetinho">√Ågua Espetinho</option>
                                    <option value="Contabilidade">Contabilidade</option>
                                    <option value="Aluguel Casa">Aluguel Casa</option>
                                    <option value="Energia El√©trica Casa">Energia El√©trica Casa</option>
                                    <option value="√Ågua Casa">√Ågua Casa</option>
                                    <option value="IPTU">IPTU</option>
                                    <option value="Internet Casa">Internet Casa</option>
                                    <option value="Supermercado">Supermercado</option>
                                    <option value="Celulares">Celulares</option>
                                    <option value="Conv√™nio crian√ßas">Conv√™nio crian√ßas</option>
                                    <option value="Cart√£o de cr√©dito Eduarda">Cart√£o de cr√©dito Eduarda</option>
                                    <option value="Juros sobre Empr√©stimos">Juros sobre Empr√©stimos</option>
                                    <option value="Multas">Multas</option>
                                    <option value="Pagamento de Empr√©stimos/D√≠vidas">Pagamento de Empr√©stimos/D√≠vidas</option>
                                    <option value="Tarifas Banc√°rias">Tarifas Banc√°rias</option>
                                    <option value="MEI">MEI</option>
                                    <option value="Simples Nacional (DAS)">Simples Nacional (DAS)</option>
                                    <option value="IOF">IOF</option>
                                    <option value="Contribui√ß√£o Social">Contribui√ß√£o Social</option>
                                    <option value="ISS">ISS</option>
                                    <option value="M√°quinas e Equipamentos">M√°quinas e Equipamentos</option>
                                    <option value="Ve√≠culos">Ve√≠culos</option>
                                    <option value="Instala√ß√µes">Instala√ß√µes</option>
                                    <option value="Equipamentos de Inform√°tica">Equipamentos de Inform√°tica</option>
                                    <option value="M√≥veis e Utens√≠lios">M√≥veis e Utens√≠lios</option>
                                    <option value="Terreno">Terreno</option>
                                    <option value="Adiantamento a Fornecedores">Adiantamento a Fornecedores</option>
                                    <option value="Devolu√ß√µes de Vendas de Mercadoria">Devolu√ß√µes de Vendas de Mercadoria</option>
                                    <option value="Devolu√ß√µes de Vendas de Servi√ßos Prestados">Devolu√ß√µes de Vendas de Servi√ßos Prestados</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorOrcamentoDespesa" class="form-label">Valor Or√ßado (R\$)</label>
                                <input type="number" class="form-control" id="valorOrcamentoDespesa" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoOrcamentoDespesa" class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="descricaoOrcamentoDespesa" rows="2" 
                                          placeholder="Detalhes sobre a previs√£o..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-despesa text-white w-100">
                                üí∏ Registrar Or√ßamento de Despesa
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Comparativos -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Relat√≥rio Comparativo - Or√ßado vs Realizado</h5>
                    </div>
                    <div class="card-body">
                        <!-- Tabs para tipos de relat√≥rio -->
                        <ul class="nav nav-tabs mb-4" id="relatorioTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="resumo-tab" data-bs-toggle="tab" 
                                        data-bs-target="#resumo" type="button" role="tab">
                                    üìà Resumo
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="detalhado-tab" data-bs-toggle="tab" 
                                        data-bs-target="#detalhado" type="button" role="tab">
                                    üìã Detalhado
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="grafico-tab" data-bs-toggle="tab" 
                                        data-bs-target="#grafico" type="button" role="tab">
                                    üìä Gr√°fico
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="relatorioTabsContent">
                            <!-- Resumo -->
                            <div class="tab-pane fade show active" id="resumo" role="tabpanel">
                                <div id="relatorioResumo">
                                    <!-- Conte√∫do ser√° carregado via JavaScript -->
                                </div>
                            </div>

                            <!-- Detalhado -->
                            <div class="tab-pane fade" id="detalhado" role="tabpanel">
                                <div id="relatorioDetalhado">
                                    <!-- Conte√∫do ser√° carregado via JavaScript -->
                                </div>
                            </div>

                            <!-- Gr√°fico -->
                            <div class="tab-pane fade" id="grafico" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <canvas id="graficoComparativo" height="100"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Lan√ßamentos de Or√ßamento -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìã Lan√ßamentos de Or√ßamento</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportarOrcamento()">
                                üì• Exportar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="limparOrcamento()">
                                üóëÔ∏è Limpar Tudo
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="listaOrcamentos" class="table-responsive">
                            <!-- Or√ßamentos ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="modalConfirmacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclus√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemConfirmacao">Tem certeza que deseja excluir este lan√ßamento?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarExclusao">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Principal -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js'
        import { 
            getFirestore,
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            deleteDoc,
            doc,
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js'

        const firebaseConfig = {
          apiKey: "AIzaSyA3e7KB1R1SbYb_HKGm52DyqAEeAN9Qpdw",
          authDomain: "sistema-fluxo-caixa-espetinho.firebaseapp.com",
          projectId: "sistema-fluxo-caixa-espetinho",
          storageBucket: "sistema-fluxo-caixa-espetinho.firebasestorage.app",
          messagingSenderId: "628667049442",
          appId: "1:628667049442:web:125e5eb32a3274dcad05bb"
        }

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)

        // Vari√°veis globais
        let orcamentos = []
        let movimentos = []
        let chart = null

        function inicializarSistema() {
            configurarAnos()
            configurarMesAtual()
            configurarEventos()
            carregarDados()
        }

        function configurarAnos() {
            const anoSelect = document.getElementById('anoSelecionado')
            const anoAtual = new Date().getFullYear()
            
            // Adicionar anos (atual - 2 at√© atual + 5)
            for (let ano = anoAtual - 2; ano <= anoAtual + 5; ano++) {
                const option = document.createElement('option')
                option.value = ano
                option.textContent = ano
                if (ano === anoAtual) option.selected = true
                anoSelect.appendChild(option)
            }
        }

        function configurarMesAtual() {
            const mesAt
