<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or√ßamento Mensal - Sistema de Fluxo de Caixa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .saldo-positivo { color: #28a745; }
        .saldo-negativo { color: #dc3545; }
        .card-header { background: linear-gradient(45deg, #007bff, #0056b3); color: white; }
        .btn-receita { background: linear-gradient(45deg, #28a745, #20c997); border: none; }
        .btn-despesa { background: linear-gradient(45deg, #dc3545, #e74c3c); border: none; }
        .btn-orcamento { background: linear-gradient(45deg, #6f42c1, #5a2d91); border: none; }
        .movimento-receita { border-left: 4px solid #28a745; }
        .movimento-despesa { border-left: 4px solid #dc3545; }
        .movimento-orcamento { border-left: 4px solid #6f42c1; }
        
        .user-info {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 20px;
        }
        
        .btn-logout {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            border-radius: 8px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white !important;
        }
        
        .badge-realizado { background-color: #28a745; }
        .badge-orcado { background-color: #6f42c1; }
        .badge-variacao-positiva { background-color: #28a745; }
        .badge-variacao-negativa { background-color: #dc3545; }
        
        .comparativo-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .comparativo-header {
            background: linear-gradient(45deg, #6f42c1, #5a2d91);
            color: white;
            padding: 10px 15px;
            border-radius: 10px 10px 0 0;
        }
        
        @media (max-width: 768px) {
            .container-fluid { padding: 10px; }
            .card { margin-bottom: 15px; }
            .btn { margin-bottom: 5px; width: 100%; }
            .table-responsive { font-size: 0.9em; }
        }
    </style>
</head>

<body class="bg-light">
    <!-- Loading Screen -->
    <div id="authLoading" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" 
         style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999;">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h5>Verificando autentica√ß√£o...</h5>
        </div>
    </div>

    <div class="container-fluid py-4" id="mainContent" style="display: none;">
        <!-- User Info Header -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="user-info d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">üìä Or√ßamento Mensal - <span id="userName">Usu√°rio</span></h6>
                        <small class="opacity-75" id="userEmail">email@exemplo.com</small>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="index.html" class="btn btn-outline-light btn-sm">
                            üí∞ Fluxo de Caixa
                        </a>
                        <button class="btn btn-logout text-white btn-sm" id="logoutBtn">
                            üö™ Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sele√ß√£o de Per√≠odo -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìÖ Per√≠odo de An√°lise</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="anoSelecionado" class="form-label">Ano *</label>
                                <select class="form-select" id="anoSelecionado" required>
                                    <!-- Anos ser√£o preenchidos via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mesSelecionado" class="form-label">M√™s (para cadastro)</label>
                                <select class="form-select" id="mesSelecionado">
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formul√°rios de Lan√ßamento de Or√ßamento -->
        <div class="row">
            <!-- Or√ßamento de Receitas -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Or√ßamento de Receitas</h5>
                    </div>
                    <div class="card-body">
                        <form id="formOrcamentoReceita">
                            <div class="mb-3">
                                <label for="categoriaOrcamentoReceita" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaOrcamentoReceita" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Clientes - Vendas no Espetinho">Clientes - Vendas no Espetinho</option>
                                    <option value="Clientes - Festas">Clientes - Festas</option>
                                    <option value="Clientes - Outras Receitas">Clientes - Outras Receitas</option>
                                    <option value="Dividendos Recebidos">Dividendos Recebidos</option>
                                    <option value="Rendimentos de Aplica√ß√µes">Rendimentos de Aplica√ß√µes</option>
                                    <option value="Devolu√ß√µes de Compra de Mercadoria de Revenda">Devolu√ß√µes de Compra de Mercadoria de Revenda</option>
                                    <option value="Devolu√ß√µes de Compra de Material de Consumo">Devolu√ß√µes de Compra de Material de Consumo</option>
                                    <option value="Devolu√ß√µes de Compra de Mat√©ria Prima">Devolu√ß√µes de Compra de Mat√©ria Prima</option>
                                    <option value="Devolu√ß√µes de Compra de Ativo">Devolu√ß√µes de Compra de Ativo</option>
                                    <option value="Devolu√ß√µes de Compra de Servi√ßos">Devolu√ß√µes de Compra de Servi√ßos</option>
                                    <option value="Adiantamento de Clientes">Adiantamento de Clientes</option>
                                    <option value="Reembolso de Despesas">Reembolso de Despesas</option>
                                    <option value="Empr√©stimos Banc√°rios">Empr√©stimos Banc√°rios</option>
                                    <option value="Venda de Ativos">Venda de Ativos</option>
                                    <option value="Saldo Inicial">Saldo Inicial</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorOrcamentoReceita" class="form-label">Valor Or√ßado (R$)</label>
                                <input type="number" class="form-control" id="valorOrcamentoReceita" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoOrcamentoReceita" class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="descricaoOrcamentoReceita" rows="2" 
                                          placeholder="Detalhes sobre a previs√£o..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-receita text-white w-100">
                                üí∞ Registrar Or√ßamento de Receita
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Or√ßamento de Despesas -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìâ Or√ßamento de Despesas</h5>
                    </div>
                    <div class="card-body">
                        <form id="formOrcamentoDespesa">
                            <div class="mb-3">
                                <label for="categoriaOrcamentoDespesa" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaOrcamentoDespesa" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Frete - Motoboy">Frete - Motoboy</option>
                                    <option value="Compras Descart√°veis/Embalagens">Compras Descart√°veis/Embalagens</option>
                                    <option value="Compra de Servi√ßos Espetinho">Compra de Servi√ßos Espetinho</option>
                                    <option value="Comiss√µes">Comiss√µes</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Despesas de Viagens">Despesas de Viagens</option>
                                    <option value="Bonifica√ß√µes">Bonifica√ß√µes</option>
                                    <option value="Sal√°rios">Sal√°rios</option>
                                    <option value="Adiantamento">Adiantamento</option>
                                    <option value="F√©rias">F√©rias</option>
                                    <option value="Rescis√µes">Rescis√µes</option>
                                    <option value="13¬∫ Sal√°rio">13¬∫ Sal√°rio</option>
                                    <option value="INSS">INSS</option>
                                    <option value="FGTS">FGTS</option>
                                    <option value="IRRF">IRRF</option>
                                    <option value="Pens√£o Aliment√≠cia">Pens√£o Aliment√≠cia</option>
                                    <option value="Assist√™ncia M√©dica">Assist√™ncia M√©dica</option>
                                    <option value="Vale Transporte">Vale Transporte</option>
                                    <option value="Vale Refei√ß√£o">Vale Refei√ß√£o</option>
                                    <option value="Seguro de Vida">Seguro de Vida</option>
                                    <option value="Outros Benef√≠cios">Outros Benef√≠cios</option>
                                    <option value="Aluguel Espetinho">Aluguel Espetinho</option>
                                    <option value="Energia El√©trica Espetinho">Energia El√©trica Espetinho</option>
                                    <option value="√Ågua Espetinho">√Ågua Espetinho</option>
                                    <option value="Contabilidade">Contabilidade</option>
                                    <option value="Aluguel Casa">Aluguel Casa</option>
                                    <option value="Energia El√©trica Casa">Energia El√©trica Casa</option>
                                    <option value="√Ågua Casa">√Ågua Casa</option>
                                    <option value="IPTU">IPTU</option>
                                    <option value="Internet Casa">Internet Casa</option>
                                    <option value="Supermercado">Supermercado</option>
                                    <option value="Celulares">Celulares</option>
                                    <option value="Conv√™nio crian√ßas">Conv√™nio crian√ßas</option>
                                    <option value="Cart√£o de cr√©dito Eduarda">Cart√£o de cr√©dito Eduarda</option>
                                    <option value="Juros sobre Empr√©stimos">Juros sobre Empr√©stimos</option>
                                    <option value="Multas">Multas</option>
                                    <option value="Pagamento de Empr√©stimos/D√≠vidas">Pagamento de Empr√©stimos/D√≠vidas</option>
                                    <option value="Tarifas Banc√°rias">Tarifas Banc√°rias</option>
                                    <option value="MEI">MEI</option>
                                    <option value="Simples Nacional (DAS)">Simples Nacional (DAS)</option>
                                    <option value="IOF">IOF</option>
                                    <option value="Contribui√ß√£o Social">Contribui√ß√£o Social</option>
                                    <option value="ISS">ISS</option>
                                    <option value="M√°quinas e Equipamentos">M√°quinas e Equipamentos</option>
                                    <option value="Ve√≠culos">Ve√≠culos</option>
                                    <option value="Instala√ß√µes">Instala√ß√µes</option>
                                    <option value="Equipamentos de Inform√°tica">Equipamentos de Inform√°tica</option>
                                    <option value="M√≥veis e Utens√≠lios">M√≥veis e Utens√≠lios</option>
                                    <option value="Terreno">Terreno</option>
                                    <option value="Adiantamento a Fornecedores">Adiantamento a Fornecedores</option>
                                    <option value="Devolu√ß√µes de Vendas de Mercadoria">Devolu√ß√µes de Vendas de Mercadoria</option>
                                    <option value="Devolu√ß√µes de Vendas de Servi√ßos Prestados">Devolu√ß√µes de Vendas de Servi√ßos Prestados</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorOrcamentoDespesa" class="form-label">Valor Or√ßado (R$)</label>
                                <input type="number" class="form-control" id="valorOrcamentoDespesa" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoOrcamentoDespesa" class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="descricaoOrcamentoDespesa" rows="2" 
                                          placeholder="Detalhes sobre a previs√£o..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-despesa text-white w-100">
                                üí∏ Registrar Or√ßamento de Despesa
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Comparativos -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Relat√≥rio Comparativo - Or√ßado vs Realizado</h5>
                    </div>
                    <div class="card-body">
                        <!-- Tabs para tipos de relat√≥rio -->
                        <ul class="nav nav-tabs mb-4" id="relatorioTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="resumo-tab" data-bs-toggle="tab" 
                                        data-bs-target="#resumo" type="button" role="tab">
                                    üìà Resumo
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="detalhado-tab" data-bs-toggle="tab" 
                                        data-bs-target="#detalhado" type="button" role="tab">
                                    üìã Detalhado
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="grafico-tab" data-bs-toggle="tab" 
                                        data-bs-target="#grafico" type="button" role="tab">
                                    üìä Gr√°fico
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="relatorioTabsContent">
                            <!-- Resumo -->
                            <div class="tab-pane fade show active" id="resumo" role="tabpanel">
                                <div id="relatorioResumo">
                                    <!-- Conte√∫do ser√° carregado via JavaScript -->
                                </div>
                            </div>

                            <!-- Detalhado -->
                            <div class="tab-pane fade" id="detalhado" role="tabpanel">
                                <div id="relatorioDetalhado">
                                    <!-- Conte√∫do ser√° carregado via JavaScript -->
                                </div>
                            </div>

                            <!-- Gr√°fico -->
                            <div class="tab-pane fade" id="grafico" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <canvas id="graficoComparativo" height="100"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Lan√ßamentos de Or√ßamento -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìã Lan√ßamentos de Or√ßamento</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportarOrcamento()">
                                üì• Exportar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="limparOrcamento()">
                                üóëÔ∏è Limpar Tudo
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="listaOrcamentos" class="table-responsive">
                            <!-- Or√ßamentos ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="modalConfirmacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclus√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemConfirmacao">Tem certeza que deseja excluir este lan√ßamento?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarExclusao">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Principal -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js'
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js'
        import { 
            getFirestore,
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            where, 
            deleteDoc,
            doc,
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js'

        // SUBSTITUA PELAS SUAS CONFIGURA√á√ïES DO FIREBASE
        const firebaseConfig = {
            apiKey: "SUA-API-KEY-AQUI",
            authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto-id",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789",
            appId: "sua-app-id"
        }

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const db = getFirestore(app)

        // Vari√°veis globais
        let currentUser = null
        let orcamentos = []
        let movimentos = []
        let chart = null

        // Verificar autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            const authLoading = document.getElementById('authLoading')
            const mainContent = document.getElementById('mainContent')
            
            if (user) {
                currentUser = user
                
                // Atualizar informa√ß√µes do usu√°rio
                document.getElementById('userName').textContent = user.displayName || 'Usu√°rio'
                document.getElementById('userEmail').textContent = user.email
                
                // Mostrar conte√∫do principal
                authLoading.style.display = 'none'
                mainContent.style.display = 'block'
                
                // Inicializar sistema de or√ßamento
                inicializarSistema()
                
            } else {
                window.location.href = 'login.html'
            }
        })

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth)
                window.location.href = 'login.html'
            } catch (error) {
                console.error('Erro ao fazer logout:', error)
            }
        })

        function inicializarSistema() {
            configurarAnos()
            configurarMesAtual()
            configurarEventos()
            carregarDados()
        }

        function configurarAnos() {
            const anoSelect = document.getElementById('anoSelecionado')
            const anoAtual = new Date().getFullYear()
            
            // Adicionar anos (atual - 2 at√© atual + 5)
            for (let ano = anoAtual - 2; ano <= anoAtual + 5; ano++) {
                const option = document.createElement('option')
                option.value = ano
                option.textContent = ano
                if (ano === anoAtual) option.selected = true
                anoSelect.appendChild(option)
            }
        }

        function configurarMesAtual() {
            const mesAtual = new Date().getMonth() + 1
            document.getElementById('mesSelecionado').value = mesAtual
        }

        function configurarEventos() {
            // Formul√°rios
            document.getElementById('formOrcamentoReceita').addEventListener('submit', (e) => {
                e.preventDefault()
                adicionarOrcamentoReceita()
            })

            document.getElementById('formOrcamentoDespesa').addEventListener('submit', (e) => {
                e.preventDefault()
                adicionarOrcamentoDespesa()
            })

            // Mudan√ßa de ano
            document.getElementById('anoSelecionado').addEventListener('change', () => {
                atualizarRelatorios()
            })
        }

        async function adicionarOrcamentoReceita() {
            if (!currentUser) return

            const categoria = document.getElementById('categoriaOrcamentoReceita').value
            const valor = parseFloat(document.getElementById('valorOrcamentoReceita').value)
            const descricao = document.getElementById('descricaoOrcamentoReceita').value
            const ano = parseInt(document.getElementById('anoSelecionado').value)
            const mes = parseInt(document.getElementById('mesSelecionado').value)

            const orcamento = {
                tipo: 'receita',
                categoria: categoria,
                valor: valor,
                ano: ano,
                mes: mes,
                descricao: descricao,
                timestamp: Timestamp.now(),
                userId: currentUser.uid
            }

            try {
                await addDoc(collection(db, 'usuarios', currentUser.uid, 'orcamentos'), orcamento)
                limparFormulario('formOrcamentoReceita')
                mostrarMensagem('Or√ßamento de receita registrado com sucesso!', 'success')
            } catch (error) {
                mostrarMensagem('Erro ao registrar or√ßamento: ' + error.message, 'error')
            }
        }

        async function adicionarOrcamentoDespesa() {
            if (!currentUser) return

            const categoria = document.getElementById('categoriaOrcamentoDespesa').value
            const valor = parseFloat(document.getElementById('valorOrcamentoDespesa').value)
            const descricao = document.getElementById('descricaoOrcamentoDespesa').value
            const ano = parseInt(document.getElementById('anoSelecionado').value)
            const mes = parseInt(document.getElementById('mesSelecionado').value)

            const orcamento = {
                tipo: 'despesa',
                categoria: categoria,
                valor: valor,
                ano: ano,
                mes: mes,
                descricao: descricao,
                timestamp: Timestamp.now(),
                userId: currentUser.uid
            }

            try {
                await addDoc(collection(db, 'usuarios', currentUser.uid, 'orcamentos'), orcamento)
                limparFormulario('formOrcamentoDespesa')
                mostrarMensagem('Or√ßamento de despesa registrado com sucesso!', 'success')
            } catch (error) {
                mostrarMensagem('Erro ao registrar or√ßamento: ' + error.message, 'error')
            }
        }

        function carregarDados() {
            if (!currentUser) return

            // Carregar or√ßamentos
            const qOrcamentos = query(
                collection(db, 'usuarios', currentUser.uid, 'orcamentos'),
                orderBy('timestamp', 'desc')
            )

            onSnapshot(qOrcamentos, (snapshot) => {
                orcamentos = []
                snapshot.forEach((doc) => {
                    orcamentos.push({
                        id: doc.id,
                        ...doc.data()
                    })
                })
                atualizarListaOrcamentos()
                atualizarRelatorios()
            })

            // Carregar movimentos (fluxo de caixa)
            const qMovimentos = query(
                collection(db, 'usuarios', currentUser.uid, 'movimentos'),
                orderBy('timestamp', 'desc')
            )

            onSnapshot(qMovimentos, (snapshot) => {
                movimentos = []
                snapshot.forEach((doc) => {
                    movimentos.push({
                        id: doc.id,
                        ...doc.data()
                    })
                })
                atualizarRelatorios()
            })
        }

        function atualizarListaOrcamentos() {
            const container = document.getElementById('listaOrcamentos')
            const anoSelecionado = parseInt(document.getElementById('anoSelecionado').value)
            
            const orcamentosFiltrados = orcamentos.filter(orc => orc.ano === anoSelecionado)

            if (orcamentosFiltrados.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhum or√ßamento encontrado para este ano.</p>'
                return
            }

            let html = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>M√™s</th>
                            <th>Tipo</th>
                            <th>Categoria</th>
                            <th>Descri√ß√£o</th>
                            <th class="text-end">Valor</th>
                            <th width="100">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
            `

            orcamentosFiltrados.forEach(orcamento => {
                const nomesMeses = [
                    'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
                ]
                
                const tipoClass = orcamento.tipo === 'receita' ? 'movimento-receita' : 'movimento-despesa'
                const tipoIcon = orcamento.tipo === 'receita' ? 'üìà' : 'üìâ'

                html += `
                    <tr class="${tipoClass}">
                        <td>${nomesMeses[orcamento.mes - 1]}</td>
                        <td>${tipoIcon} ${orcamento.tipo.charAt(0).toUpperCase() + orcamento.tipo.slice(1)}</td>
                        <td>${orcamento.categoria}</td>
                        <td>${orcamento.descricao || '-'}</td>
                        <td class="text-end ${orcamento.tipo === 'receita' ? 'text-success' : 'text-danger'}">
                            ${formatarMoeda(orcamento.valor)}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusao('${orcamento.id}', '${orcamento.categoria}')">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `
            })

            html += '</tbody></table>'
            container.innerHTML = html
        }

        function atualizarRelatorios() {
            atualizarRelatorioResumo()
            atualizarRelatorioDetalhado()
            atualizarGraficoComparativo()
        }

        function atualizarRelatorioResumo() {
            const container = document.getElementById('relatorioResumo')
            const anoSelecionado = parseInt(document.getElementById('anoSelecionado').value)
            
            const nomesMeses = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ]

            let html = '<div class="row">'

            for (let mes = 1; mes <= 12; mes++) {
                const dadosMes = calcularDadosMes(anoSelecionado, mes)
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="comparativo-card">
                            <div class="comparativo-header">
                                <h6 class="mb-0">${nomesMeses[mes - 1]} ${anoSelecionado}</h6>
                            </div>
                            <div class="p-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h6 class="text-success">Receitas</h6>
                                        <small class="badge badge-orcado mb-1">Or√ßado: ${formatarMoeda(dadosMes.receitasOrcadas)}</small><br>
                                        <small class="badge badge-realizado">Realizado: ${formatarMoeda(dadosMes.receitasRealizadas)}</small>
                                        <div class="mt-1">
                                            <span class="badge ${dadosMes.variacao.receitas >= 0 ? 'badge-variacao-positiva' : 'badge-variacao-negativa'}">
                                                ${dadosMes.variacao.receitas >= 0 ? '+' : ''}${formatarMoeda(dadosMes.variacao.receitas)}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-danger">Despesas</h6>
                                        <small class="badge badge-orcado mb-1">Or√ßado: ${formatarMoeda(dadosMes.despesasOrcadas)}</small><br>
                                        <small class="badge badge-realizado">Realizado: ${formatarMoeda(dadosMes.despesasRealizadas)}</small>
                                        <div class="mt-1">
                                            <span class="badge ${dadosMes.variacao.despesas <= 0 ? 'badge-variacao-positiva' : 'badge-variacao-negativa'}">
                                                ${dadosMes.variacao.despesas >= 0 ? '+' : ''}${formatarMoeda(dadosMes.variacao.despesas)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <h6>Saldo</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="badge badge-orcado">Or√ßado: ${formatarMoeda(dadosMes.saldoOrcado)}</small>
                                        </div>
                                        <div class="col-6">
                                            <small class="badge badge-realizado">Realizado: ${formatarMoeda(dadosMes.saldoRealizado)}</small>
                                        </div>
                                    </div>
                                    <div class="mt-1">
                                        <span class="badge ${dadosMes.variacao.saldo >= 0 ? 'badge-variacao-positiva' : 'badge-variacao-negativa'}">
                                            Varia√ß√£o: ${dadosMes.variacao.saldo >= 0 ? '+' : ''}${formatarMoeda(dadosMes.variacao.saldo)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            }

            html += '</div>'
            container.innerHTML = html
        }

        function atualizarRelatorioDetalhado() {
            const container = document.getElementById('relatorioDetalhado')
            const anoSelecionado = parseInt(document.getElementById('anoSelecionado').value)
            
            // Obter todas as categorias √∫nicas
            const todasCategorias = new Set()
            orcamentos.forEach(orc => {
                if (orc.ano === anoSelecionado) {
                    todasCategorias.add(orc.categoria)
                }
            })
            movimentos.forEach(mov => {
                const dataMovimento = mov.data.toDate()
                if (dataMovimento.getFullYear() === anoSelecionado) {
                    todasCategorias.add(mov.categoria)
                }
            })

            if (todasCategorias.size === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhum dado encontrado para an√°lise detalhada.</p>'
                return
            }

            const nomesMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez']

            let html = `
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2">Categoria</th>
                                <th rowspan="2">Tipo</th>
            `

            nomesMeses.forEach(mes => {
                html += `<th colspan="3" class="text-center">${mes}</th>`
            })

            html += `
                            </tr>
                            <tr>
            `

            nomesMeses.forEach(() => {
                html += `
                    <th class="text-center" style="font-size: 0.8em;">Or√ßado</th>
                    <th class="text-center" style="font-size: 0.8em;">Realizado</th>
                    <th class="text-center" style="font-size: 0.8em;">Var.</th>
                `
            })

            html += `
                            </tr>
                        </thead>
                        <tbody>
            `

            Array.from(todasCategorias).sort().forEach(categoria => {
                // Determinar o tipo predominante da categoria
                const tipoCategoria = determinarTipoCategoria(categoria, anoSelecionado)
                
                html += `
                    <tr>
                        <td>${categoria}</td>
                        <td class="text-center">
                            <span class="badge ${tipoCategoria === 'receita' ? 'badge-receita bg-success' : 'badge-despesa bg-danger'}">
                                ${tipoCategoria === 'receita' ? 'üìà' : 'üìâ'}
                            </span>
                        </td>
                `

                for (let mes = 1; mes <= 12; mes++) {
                    const dadosCategoriaMes = calcularDadosCategoriaMes(categoria, anoSelecionado, mes)
                    
                    html += `
                        <td class="text-end" style="font-size: 0.8em;">${dadosCategoriaMes.orcado > 0 ? formatarMoedaCompacta(dadosCategoriaMes.orcado) : '-'}</td>
                        <td class="text-end" style="font-size: 0.8em;">${dadosCategoriaMes.realizado > 0 ? formatarMoedaCompacta(dadosCategoriaMes.realizado) : '-'}</td>
                        <td class="text-end" style="font-size: 0.8em;">
                            ${dadosCategoriaMes.variacao !== 0 ? 
                                `<span class="text-${dadosCategoriaMes.variacao >= 0 ? 'success' : 'danger'}">${dadosCategoriaMes.variacao >= 0 ? '+' : ''}${formatarMoedaCompacta(dadosCategoriaMes.variacao)}</span>` 
                                : '-'}
                        </td>
                    `
                }

                html += '</tr>'
            })

            html += `
                        </tbody>
                    </table>
                </div>
            `

            container.innerHTML = html
        }

        function atualizarGraficoComparativo() {
            const ctx = document.getElementById('graficoComparativo').getContext('2d')
            
            if (chart) {
                chart.destroy()
            }

            const anoSelecionado = parseInt(document.getElementById('anoSelecionado').value)
            const dadosGrafico = prepararDadosGrafico(anoSelecionado)

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [
                        {
                            label: 'Receitas Or√ßadas',
                            data: dadosGrafico.receitasOrcadas,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'Receitas Realizadas',
                            data: dadosGrafico.receitasRealizadas,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            fill: false
                        },
                        {
                            label: 'Despesas Or√ßadas',
                            data: dadosGrafico.despesasOrcadas,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'Despesas Realizadas',
                            data: dadosGrafico.despesasRealizadas,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 0 })
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': R$ ' + 
                                           context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                }
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            })
        }

        function calcularDadosMes(ano, mes) {
            // Calcular or√ßamentos do m√™s
            const orcamentosMes = orcamentos.filter(orc => orc.ano === ano && orc.mes === mes)
            const receitasOrcadas = orcamentosMes
                .filter(orc => orc.tipo === 'receita')
                .reduce((total, orc) => total + orc.valor, 0)
            const despesasOrcadas = orcamentosMes
                .filter(orc => orc.tipo === 'despesa')
                .reduce((total, orc) => total + orc.valor, 0)

            // Calcular realizados do m√™s
            const movimentosMes = movimentos.filter(mov => {
                const dataMovimento = mov.data.toDate()
                return dataMovimento.getFullYear() === ano && dataMovimento.getMonth() === mes - 1
            })
            const receitasRealizadas = movimentosMes
                .filter(mov => mov.valor > 0)
                .reduce((total, mov) => total + mov.valor, 0)
            const despesasRealizadas = Math.abs(movimentosMes
                .filter(mov => mov.valor < 0)
                .reduce((total, mov) => total + mov.valor, 0))

            const saldoOrcado = receitasOrcadas - despesasOrcadas
            const saldoRealizado = receitasRealizadas - despesasRealizadas

            return {
                receitasOrcadas,
                despesasOrcadas,
                receitasRealizadas,
                despesasRealizadas,
                saldoOrcado,
                saldoRealizado,
                variacao: {
                    receitas: receitasRealizadas - receitasOrcadas,
                    despesas: despesasRealizadas - despesasOrcadas,
                    saldo: saldoRealizado - saldoOrcado
                }
            }
        }

        function calcularDadosCategoriaMes(categoria, ano, mes) {
            // Or√ßado
            const orcado = orcamentos
                .filter(orc => orc.categoria === categoria && orc.ano === ano && orc.mes === mes)
                .reduce((total, orc) => total + orc.valor, 0)

            // Realizado
            const realizado = movimentos
                .filter(mov => {
                    const dataMovimento = mov.data.toDate()
                    return mov.categoria === categoria && 
                           dataMovimento.getFullYear() === ano && 
                           dataMovimento.getMonth() === mes - 1
                })
                .reduce((total, mov) => total + Math.abs(mov.valor), 0)

            return {
                orcado,
                realizado,
                variacao: realizado - orcado
            }
        }

        function determinarTipoCategoria(categoria, ano) {
            // Verificar nos or√ßamentos
            const orcamentoCategoria = orcamentos.find(orc => 
                orc.categoria === categoria && orc.ano === ano
            )
            if (orcamentoCategoria) {
                return orcamentoCategoria.tipo
            }

            // Verificar nos movimentos
            const movimentoCategoria = movimentos.find(mov => 
                mov.categoria === categoria
            )
            if (movimentoCategoria) {
                return movimentoCategoria.valor > 0 ? 'receita' : 'despesa'
            }

            return 'receita' // default
        }

        function prepararDadosGrafico(ano) {
            const receitasOrcadas = []
            const despesasOrcadas = []
            const receitasRealizadas = []
            const despesasRealizadas = []

            for (let mes = 1; mes <= 12; mes++) {
                const dados = calcularDadosMes(ano, mes)
                receitasOrcadas.push(dados.receitasOrcadas)
                despesasOrcadas.push(dados.despesasOrcadas)
                receitasRealizadas.push(dados.receitasRealizadas)
                despesasRealizadas.push(dados.despesasRealizadas)
            }

            return {
                receitasOrcadas,
                despesasOrcadas,
                receitasRealizadas,
                despesasRealizadas
            }
        }

        // Fun√ß√µes utilit√°rias
        function formatarMoeda(valor) {
            return 'R$ ' + Math.abs(valor).toLocaleString('pt-BR', { 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })
        }

        function formatarMoedaCompacta(valor) {
            if (Math.abs(valor) >= 1000000) {
                return 'R$ ' + (valor / 1000000).toFixed(1) + 'M'
            } else if (Math.abs(valor) >= 1000) {
                return 'R$ ' + (valor / 1000).toFixed(1) + 'k'
            } else {
                return 'R$ ' + valor.toFixed(0)
            }
        }

        function limparFormulario(formId) {
            document.getElementById(formId).reset()
        }

        function mostrarMensagem(mensagem, tipo) {
            const alertDiv = document.createElement('div')
            alertDiv.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;'
            alertDiv.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `
            
            document.body.appendChild(alertDiv)
            
            setTimeout(() => {
                alertDiv.remove()
            }, 5000)
        }

        // Fun√ß√µes globais para exclus√£o
        let itemParaExcluir = null

        window.confirmarExclusao = function(id, categoria) {
            itemParaExcluir = id
            document.getElementById('mensagemConfirmacao').textContent = 
                `Tem certeza que deseja excluir o or√ßamento da categoria "${categoria}"?`
            
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'))
            modal.show()
        }

        document.getElementById('confirmarExclusao').addEventListener('click', async () => {
            if (itemParaExcluir) {
                try {
                    await deleteDoc(doc(db, 'usuarios', currentUser.uid, 'orcamentos', itemParaExcluir))
                    mostrarMensagem('Or√ßamento exclu√≠do com sucesso!', 'success')
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacao'))
                    modal.hide()
                    
                    itemParaExcluir = null
                } catch (error) {
                    mostrarMensagem('Erro ao excluir or√ßamento: ' + error.message, 'error')
                }
            }
        })

        window.exportarOrcamento = function() {
            const anoSelecionado = parseInt(document.getElementById('anoSelecionado').value)
            const orcamentosFiltrados = orcamentos.filter(orc => orc.ano === anoSelecionado)
            
            const nomesMeses = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ]

            const dados = orcamentosFiltrados.map(orc => ({
                Ano: orc.ano,
                M√™s: nomesMeses[orc.mes - 1],
                Tipo: orc.tipo,
                Categoria: orc.categoria,
                'Valor Or√ßado': orc.valor,
                Descri√ß√£o: orc.descricao || ''
            }))

            const csv = [
                ['Ano', 'M√™s', 'Tipo', 'Categoria', 'Valor Or√ßado', 'Descri√ß√£o'],
                ...dados.map(row => Object.values(row))
            ].map(row => row.join(';')).join('\n')

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `orcamento_${anoSelecionado}_${new Date().toISOString().split('T')[0]}.csv`
            link.click()
        }

        window.limparOrcamento = function() {
            if (confirm('Tem certeza que deseja excluir TODOS os or√ßamentos? Esta a√ß√£o n√£o pode ser desfeita!')) {
                const anoSelecionado = parseInt(document.getElementById('anoSelecionado').value)
                const orcamentosParaExcluir = orcamentos.filter(orc => orc.ano === anoSelecionado)
                
                Promise.all(orcamentosParaExcluir.map(orc => 
                    deleteDoc(doc(db, 'usuarios', currentUser.uid, 'orcamentos', orc.id))
                )).then(() => {
                    mostrarMensagem('Todos os or√ßamentos foram exclu√≠dos!', 'success')
                }).catch(error => {
                    mostrarMensagem('Erro ao excluir or√ßamentos: ' + error.message, 'error')
                })
            }
        }
    </script>
</body>
</html>
