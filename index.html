<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fluxo de Caixa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
       <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Principal -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js'
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js'
        import { 
            getFirestore,
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            where, 
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js'

       // Import the functions you need from the SDKs you need
		import { initializeApp } from "firebase/app";
		// TODO: Add SDKs for Firebase products that you want to use
		// https://firebase.google.com/docs/web/setup#available-libraries

		// Your web app's Firebase configuration
		const firebaseConfig = {
		  apiKey: "AIzaSyA3e7KB1R1SbYb_HKGm52DyqAEeAN9Qpdw",
		  authDomain: "sistema-fluxo-caixa-espetinho.firebaseapp.com",
		  projectId: "sistema-fluxo-caixa-espetinho",
		  storageBucket: "sistema-fluxo-caixa-espetinho.firebasestorage.app",
		  messagingSenderId: "628667049442",
		  appId: "1:628667049442:web:125e5eb32a3274dcad05bb"
		};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const db = getFirestore(app)

        // Vari√°vel global para o usu√°rio atual
        let currentUser = null

        // Verificar autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            const authLoading = document.getElementById('authLoading')
            const mainContent = document.getElementById('mainContent')
            
            if (user) {
                // Usu√°rio autenticado
                currentUser = user
                
                // Atualizar informa√ß√µes do usu√°rio na interface
                document.getElementById('userName').textContent = user.displayName || 'Usu√°rio'
                document.getElementById('userEmail').textContent = user.email
                
                // Mostrar conte√∫do principal
                authLoading.style.display = 'none'
                mainContent.style.display = 'block'
                
                // Inicializar sistema de fluxo de caixa
                window.fluxoCaixa = new FluxoCaixa()
                
            } else {
                // Usu√°rio n√£o autenticado, redirecionar para login
                window.location.href = 'login.html'
            }
        })

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth)
                window.location.href = 'login.html'
            } catch (error) {
                console.error('Erro ao fazer logout:', error)
            }
        })

        class FluxoCaixa {
            constructor() {
                this.movimentos = []
                this.chart = null
                this.inicializar()
            }

            inicializar() {
                this.configurarEventos()
                this.carregarDados()
                this.configurarDatasPadrao()
            }

            configurarDatasPadrao() {
                const hoje = new Date()
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1)
                
                document.getElementById('dataInicio').value = inicioMes.toISOString().split('T')[0]
                document.getElementById('dataFim').value = hoje.toISOString().split('T')[0]
                document.getElementById('dataReceita').value = hoje.toISOString().split('T')[0]
                document.getElementById('dataDespesa').value = hoje.toISOString().split('T')[0]
            }

            configurarEventos() {
                // Form de receita
                document.getElementById('formReceita').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.adicionarReceita()
                })

                // Form de despesa
                document.getElementById('formDespesa').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.adicionarDespesa()
                })

                // Per√≠odo padr√£o
                document.getElementById('periodoPadrao').addEventListener('change', (e) => {
                    if (e.target.value) {
                        const dias = parseInt(e.target.value)
                        const hoje = new Date()
                        const inicio = new Date(hoje.getTime() - (dias * 24 * 60 * 60 * 1000))
                        
                        document.getElementById('dataInicio').value = inicio.toISOString().split('T')[0]
                        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0]
                    }
                })
            }

            async adicionarReceita() {
                if (!currentUser) return

                const categoria = document.getElementById('categoriaReceita').value
                const valor = parseFloat(document.getElementById('valorReceita').value)
                const data = document.getElementById('dataReceita').value
                const descricao = document.getElementById('descricaoReceita').value
                const cancelamento = document.getElementById('cancelamentoReceita').checked

                const movimento = {
                    tipo: cancelamento ? 'cancelamento' : 'receita',
                    categoria: cancelamento ? 'Cancelamento' : categoria,
                    valor: cancelamento ? -valor : valor,
                    data: Timestamp.fromDate(new Date(data)),
                    descricao: descricao,
                    timestamp: Timestamp.now(),
                    userId: currentUser.uid
                }

                try {
                    // Salvar na cole√ß√£o espec√≠fica do usu√°rio
                    await addDoc(collection(db, 'usuarios', currentUser.uid, 'movimentos'), movimento)
                    this.limparFormulario('formReceita')
                    this.mostrarMensagem('Receita registrada com sucesso!', 'success')
                } catch (error) {
                    this.mostrarMensagem('Erro ao registrar receita: ' + error.message, 'error')
                }
            }

            async adicionarDespesa() {
                if (!currentUser) return

                const categoria = document.getElementById('categoriaDespesa').value
                const valor = parseFloat(document.getElementById('valorDespesa').value)
                const data = document.getElementById('dataDespesa').value
                const descricao = document.getElementById('descricaoDespesa').value
                const cancelamento = document.getElementById('cancelamentoDespesa').checked

                const movimento = {
                    tipo: cancelamento ? 'cancelamento' : 'despesa',
                    categoria: cancelamento ? 'Cancelamento' : categoria,
                    valor: cancelamento ? valor : -valor,
                    data: Timestamp.fromDate(new Date(data)),
                    descricao: descricao,
                    timestamp: Timestamp.now(),
                    userId: currentUser.uid
                }

                try {
                    // Salvar na cole√ß√£o espec√≠fica do usu√°rio
                    await addDoc(collection(db, 'usuarios', currentUser.uid, 'movimentos'), movimento)
                    this.limparFormulario('formDespesa')
                    this.mostrarMensagem('Despesa registrada com sucesso!', 'success')
                } catch (error) {
                    this.mostrarMensagem('Erro ao registrar despesa: ' + error.message, 'error')
                }
            }

            carregarDados() {
                if (!currentUser) return

                // Query para carregar apenas os dados do usu√°rio atual
                const q = query(
                    collection(db, 'usuarios', currentUser.uid, 'movimentos'),
                    orderBy('timestamp', 'desc')
                )

                onSnapshot(q, (snapshot) => {
                    this.movimentos = []
                    snapshot.forEach((doc) => {
                        this.movimentos.push({
                            id: doc.id,
                            ...doc.data()
                        })
                    })
                    this.atualizarInterface()
                })
            }

            // Resto dos m√©todos permanecem iguais...
            atualizarInterface() {
                this.calcularSaldos()
                this.atualizarListaMovimentos()
                this.atualizarGrafico()
            }

            calcularSaldos() {
                const dataInicio = document.getElementById('dataInicio').value
                const dataFim = document.getElementById('dataFim').value
                
                let movimentosFiltrados = this.movimentos

                if (dataInicio && dataFim) {
                    const inicio = new Date(dataInicio)
                    const fim = new Date(dataFim)
                    fim.setHours(23, 59, 59, 999)

                    movimentosFiltrados = this.movimentos.filter(mov => {
                        const dataMovimento = mov.data.toDate()
                        return dataMovimento >= inicio && dataMovimento <= fim
                    })
                }

                const totalReceitas = movimentosFiltrados
                    .filter(mov => mov.valor > 0)
                    .reduce((total, mov) => total + mov.valor, 0)

                const totalDespesas = Math.abs(movimentosFiltrados
                    .filter(mov => mov.valor < 0)
                    .reduce((total, mov) => total + mov.valor, 0))

                const saldoPeriodo = totalReceitas - totalDespesas
                const saldoTotal = this.movimentos.reduce((total, mov) => total + mov.valor, 0)

                document.getElementById('totalReceitas').textContent = this.formatarMoeda(totalReceitas)
                document.getElementById('totalDespesas').textContent = this.formatarMoeda(totalDespesas)
                document.getElementById('saldoPeriodo').textContent = this.formatarMoeda(saldoPeriodo)
                document.getElementById('saldoPeriodo').className = saldoPeriodo >= 0 ? 'text-success' : 'text-danger'
                
                const saldoAtualElement = document.getElementById('saldoAtual')
                saldoAtualElement.textContent = this.formatarMoeda(saldoTotal)
                saldoAtualElement.className = saldoTotal >= 0 ? 'saldo-positivo' : 'saldo-negativo'
            }

            atualizarListaMovimentos() {
                const container = document.getElementById('listaMovimentos')
                
                if (this.movimentos.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Nenhum movimento encontrado.</p>'
                    return
                }

                const movimentosLimitados = this.movimentos.slice(0, 50)

                let html = `
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Categoria</th>
                                <th>Descri√ß√£o</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                `

                movimentosLimitados.forEach(movimento => {
                    const data = movimento.data.toDate()
                    let tipoClass = movimento.valor > 0 ? 'movimento-receita' : 'movimento-despesa'
                    let tipoIcon = movimento.valor > 0 ? 'üìà' : 'üìâ'
                    
                    if (movimento.tipo === 'cancelamento') {
                        tipoClass = 'movimento-cancelamento'
                        tipoIcon = '‚ö†Ô∏è'
                    }

                    html += `
                        <tr class="${tipoClass}">
                            <td>${data.toLocaleDateString('pt-BR')}</td>
                            <td>${tipoIcon} ${movimento.tipo.charAt(0).toUpperCase() + movimento.tipo.slice(1)}</td>
                            <td>${movimento.categoria}</td>
                            <td>${movimento.descricao || '-'}</td>
                            <td class="text-end ${movimento.valor >= 0 ? 'text-success' : 'text-danger'}">
                                ${this.formatarMoeda(movimento.valor)}
                            </td>
                        </tr>
                    `
                })

                html += '</tbody></table>'
                container.innerHTML = html
            }

            atualizarGrafico() {
                const ctx = document.getElementById('graficoFluxo').getContext('2d')
                
                if (this.chart) {
                    this.chart.destroy()
                }

                const dadosGrafico = this.prepararDadosGrafico()

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dadosGrafico.labels,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: dadosGrafico.receitas,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Despesas',
                                data: dadosGrafico.despesas,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Saldo Acumulado',
                                data: dadosGrafico.saldoAcumulado,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': R$ ' + 
                                               context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                    }
                                }
                            }
                        }
                    }
                })
            }

            prepararDadosGrafico() {
                // Agrupa movimentos por dia
                const movimentosPorDia = {}
                
                this.movimentos.forEach(movimento => {
                    const data = movimento.data.toDate().toISOString().split('T')[0]
                    if (!movimentosPorDia[data]) {
                        movimentosPorDia[data] = { receitas: 0, despesas: 0 }
                    }
                    
                    if (movimento.valor > 0) {
                        movimentosPorDia[data].receitas += movimento.valor
                    } else {
                        movimentosPorDia[data].despesas += Math.abs(movimento.valor)
                    }
                })

                // Ordena as datas
                const datasOrdenadas = Object.keys(movimentosPorDia).sort()
                
                const labels = []
                const receitas = []
                const despesas = []
                const saldoAcumulado = []
                let saldoAtual = 0

                datasOrdenadas.forEach(data => {
                    const dataFormatada = new Date(data).toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    })
                    
                    labels.push(dataFormatada)
                    receitas.push(movimentosPorDia[data].receitas)
                    despesas.push(movimentosPorDia[data].despesas)
                    
                    saldoAtual += movimentosPorDia[data].receitas - movimentosPorDia[data].despesas
                    saldoAcumulado.push(saldoAtual)
                })

                return { labels, receitas, despesas, saldoAcumulado }
            }

            limparFormulario(formId) {
                document.getElementById(formId).reset()
                
                // Restaura a data atual
                const hoje = new Date().toISOString().split('T')[0]
                if (formId === 'formReceita') {
                    document.getElementById('dataReceita').value = hoje
                } else {
                    document.getElementById('dataDespesa').value = hoje
                }
            }

            formatarMoeda(valor) {
                return 'R$ ' + Math.abs(valor).toLocaleString('pt-BR', { 
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })
            }

            mostrarMensagem(mensagem, tipo) {
                // Cria um alert Bootstrap
                const alertDiv = document.createElement('div')
                alertDiv.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show`
                alertDiv.innerHTML = `
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `
                
                document.body.insertBefore(alertDiv, document.body.firstChild)
                
                // Remove automaticamente ap√≥s 5 segundos
                setTimeout(() => {
                    alertDiv.remove()
                }, 5000)
            }
        }

        // Fun√ß√µes globais
        window.filtrarDados = function() {
            if (window.fluxoCaixa) {
                window.fluxoCaixa.atualizarInterface()
            }
        }

        window.exportarDados = function() {
            if (!window.fluxoCaixa) return
            
            const dados = window.fluxoCaixa.movimentos.map(mov => ({
                Data: mov.data.toDate().toLocaleDateString('pt-BR'),
                Tipo: mov.tipo,
                Categoria: mov.categoria,
                Descri√ß√£o: mov.descricao || '',
                Valor: mov.valor
            }))

            const csv = [
                ['Data', 'Tipo', 'Categoria', 'Descri√ß√£o', 'Valor'],
                ...dados.map(row => Object.values(row))
            ].map(row => row.join(';')).join('\n')

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `fluxo_caixa_${new Date().toISOString().split('T')[0]}.csv`
            link.click()
        }
    </script>
</body>
</html>
	
</body>

</html>


