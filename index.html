<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fluxo de Caixa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .saldo-positivo { color: #28a745; }
        .saldo-negativo { color: #dc3545; }
        .card-header { background: linear-gradient(45deg, #007bff, #0056b3); color: white; }
        .btn-receita { background: linear-gradient(45deg, #28a745, #20c997); border: none; }
        .btn-despesa { background: linear-gradient(45deg, #dc3545, #e74c3c); border: none; }
        .movimento-receita { border-left: 4px solid #28a745; }
        .movimento-despesa { border-left: 4px solid #dc3545; }
        
        .header-info {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .btn-delete {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            color: white;
            font-size: 0.8em;
        }
        
        .btn-delete:hover {
            background: linear-gradient(45deg, #c82333, #a71e2a);
            color: white;
        }
        
        @media (max-width: 768px) {
            .container-fluid { padding: 10px; }
            .card { margin-bottom: 15px; }
            .btn { margin-bottom: 5px; width: 100%; }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="header-info d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">üí∞ Sistema de Fluxo de Caixa</h4>
                        <small class="opacity-75">Controle suas finan√ßas de forma simples</small>
                    </div>
                    <div>
                        <a href="orcamento.html" class="btn btn-outline-light btn-sm">
                            üìä Or√ßamento
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saldo Atual -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h5 class="mb-0">üí∞ Saldo Atual em Caixa</h5>
                    </div>
                    <div class="card-body text-center">
                        <h3 id="saldoAtual" class="mb-0">R$ 0,00</h3>
                        <small class="text-muted">Atualizado em tempo real</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formul√°rios de Lan√ßamento -->
        <div class="row">
            <!-- Lan√ßamento de Receitas -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Lan√ßamento de Receitas</h5>
                    </div>
                    <div class="card-body">
                        <form id="formReceita">
                            <div class="mb-3">
                                <label for="categoriaReceita" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaReceita" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Clientes - Vendas no Espetinho">Clientes - Vendas no Espetinho</option>
                                    <option value="Clientes - Festas">Clientes - Festas</option>
                                    <option value="Clientes - Outras Receitas">Clientes - Outras Receitas</option>
                                    <option value="Dividendos Recebidos">Dividendos Recebidos</option>
                                    <option value="Rendimentos de Aplica√ß√µes">Rendimentos de Aplica√ß√µes</option>
                                    <option value="Devolu√ß√µes de Compra de Mercadoria de Revenda">Devolu√ß√µes de Compra de Mercadoria de Revenda</option>
                                    <option value="Devolu√ß√µes de Compra de Material de Consumo">Devolu√ß√µes de Compra de Material de Consumo</option>
                                    <option value="Devolu√ß√µes de Compra de Mat√©ria Prima">Devolu√ß√µes de Compra de Mat√©ria Prima</option>
                                    <option value="Devolu√ß√µes de Compra de Ativo">Devolu√ß√µes de Compra de Ativo</option>
                                    <option value="Devolu√ß√µes de Compra de Servi√ßos">Devolu√ß√µes de Compra de Servi√ßos</option>
                                    <option value="Adiantamento de Clientes">Adiantamento de Clientes</option>
                                    <option value="Reembolso de Despesas">Reembolso de Despesas</option>
                                    <option value="Empr√©stimos Banc√°rios">Empr√©stimos Banc√°rios</option>
                                    <option value="Venda de Ativos">Venda de Ativos</option>
                                    <option value="Saldo Inicial">Saldo Inicial</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorReceita" class="form-label">Valor (R$)</label>
                                <input type="number" class="form-control" id="valorReceita" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="dataReceita" class="form-label">Data</label>
                                <input type="date" class="form-control" id="dataReceita" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoReceita" class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="descricaoReceita" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-receita text-white w-100">
                                üí∞ Registrar Receita
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Lan√ßamento de Despesas -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìâ Lan√ßamento de Despesas</h5>
                    </div>
                    <div class="card-body">
                        <form id="formDespesa">
                            <div class="mb-3">
                                <label for="categoriaDespesa" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaDespesa" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Frete - Motoboy">Frete - Motoboy</option>
                                    <option value="Compras Descart√°veis/Embalagens">Compras Descart√°veis/Embalagens</option>
                                    <option value="Compra de Servi√ßos Espetinho">Compra de Servi√ßos Espetinho</option>
                                    <option value="Comiss√µes">Comiss√µes</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Despesas de Viagens">Despesas de Viagens</option>
                                    <option value="Bonifica√ß√µes">Bonifica√ß√µes</option>
                                    <option value="Sal√°rios">Sal√°rios</option>
                                    <option value="Adiantamento">Adiantamento</option>
                                    <option value="F√©rias">F√©rias</option>
                                    <option value="Rescis√µes">Rescis√µes</option>
                                    <option value="13¬∫ Sal√°rio">13¬∫ Sal√°rio</option>
                                    <option value="INSS">INSS</option>
                                    <option value="FGTS">FGTS</option>
                                    <option value="IRRF">IRRF</option>
                                    <option value="Pens√£o Aliment√≠cia">Pens√£o Aliment√≠cia</option>
                                    <option value="Assist√™ncia M√©dica">Assist√™ncia M√©dica</option>
                                    <option value="Vale Transporte">Vale Transporte</option>
                                    <option value="Vale Refei√ß√£o">Vale Refei√ß√£o</option>
                                    <option value="Seguro de Vida">Seguro de Vida</option>
                                    <option value="Outros Benef√≠cios">Outros Benef√≠cios</option>
                                    <option value="Aluguel Espetinho">Aluguel Espetinho</option>
                                    <option value="Energia El√©trica Espetinho">Energia El√©trica Espetinho</option>
                                    <option value="√Ågua Espetinho">√Ågua Espetinho</option>
                                    <option value="Contabilidade">Contabilidade</option>
                                    <option value="Aluguel Casa">Aluguel Casa</option>
                                    <option value="Energia El√©trica Casa">Energia El√©trica Casa</option>
                                    <option value="√Ågua Casa">√Ågua Casa</option>
                                    <option value="IPTU">IPTU</option>
                                    <option value="Internet Casa">Internet Casa</option>
                                    <option value="Supermercado">Supermercado</option>
                                    <option value="Celulares">Celulares</option>
                                    <option value="Conv√™nio crian√ßas">Conv√™nio crian√ßas</option>
                                    <option value="Cart√£o de cr√©dito Eduarda">Cart√£o de cr√©dito Eduarda</option>
                                    <option value="Juros sobre Empr√©stimos">Juros sobre Empr√©stimos</option>
                                    <option value="Multas">Multas</option>
                                    <option value="Pagamento de Empr√©stimos/D√≠vidas">Pagamento de Empr√©stimos/D√≠vidas</option>
                                    <option value="Tarifas Banc√°rias">Tarifas Banc√°rias</option>
                                    <option value="MEI">MEI</option>
                                    <option value="Simples Nacional (DAS)">Simples Nacional (DAS)</option>
                                    <option value="IOF">IOF</option>
                                    <option value="Contribui√ß√£o Social">Contribui√ß√£o Social</option>
                                    <option value="ISS">ISS</option>
                                    <option value="M√°quinas e Equipamentos">M√°quinas e Equipamentos</option>
                                    <option value="Ve√≠culos">Ve√≠culos</option>
                                    <option value="Instala√ß√µes">Instala√ß√µes</option>
                                    <option value="Equipamentos de Inform√°tica">Equipamentos de Inform√°tica</option>
                                    <option value="M√≥veis e Utens√≠lios">M√≥veis e Utens√≠lios</option>
                                    <option value="Terreno">Terreno</option>
                                    <option value="Adiantamento a Fornecedores">Adiantamento a Fornecedores</option>
                                    <option value="Devolu√ß√µes de Vendas de Mercadoria">Devolu√ß√µes de Vendas de Mercadoria</option>
                                    <option value="Devolu√ß√µes de Vendas de Servi√ßos Prestados">Devolu√ß√µes de Vendas de Servi√ßos Prestados</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorDespesa" class="form-label">Valor (R$)</label>
                                <input type="number" class="form-control" id="valorDespesa" step="0.01" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="dataDespesa" class="form-label">Data</label>
                                <input type="date" class="form-control" id="dataDespesa" required>
                            </div>
                            <div class="mb-3">
                                <label for="descricaoDespesa" class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" id="descricaoDespesa" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-despesa text-white w-100">
                                üí∏ Registrar Despesa
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros e Relat√≥rios -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Relat√≥rios e Filtros</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="dataInicio" class="form-label">Data In√≠cio</label>
                                <input type="date" class="form-control" id="dataInicio">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="dataFim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="dataFim">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="periodoPadrao" class="form-label">Per√≠odo</label>
                                <select class="form-select" id="periodoPadrao">
                                    <option value="">Per√≠odo personalizado</option>
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="30">√öltimos 30 dias</option>
                                    <option value="90">√öltimos 3 meses</option>
                                    <option value="365">√öltimo ano</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label d-block">&nbsp;</label>
                                <button type="button" class="btn btn-primary w-100" onclick="filtrarDados()">
                                    üîç Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumo Financeiro -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">üí∞ Total Receitas</h5>
                        <h3 id="totalReceitas" class="text-success">R$ 0,00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">üí∏ Total Despesas</h5>
                        <h3 id="totalDespesas" class="text-danger">R$ 0,00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">üìà Saldo Per√≠odo</h5>
                        <h3 id="saldoPeriodo">R$ 0,00</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Fluxo de Caixa</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="graficoFluxo" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Movimentos -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìã √öltimos Movimentos</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportarDados()">
                            üì• Exportar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="listaMovimentos" class="table-responsive">
                            <!-- Movimentos ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚ö†Ô∏è Confirmar Exclus√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemExclusao">Tem certeza que deseja excluir este movimento?</p>
                    <div class="alert alert-warning">
                        <small><strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarExclusaoMovimento">
                        üóëÔ∏è Excluir Movimento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript Principal -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js'
        import { 
            getFirestore,
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            deleteDoc,
            doc,
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js'


            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyA3e7KB1R1SbYb_HKGm52DyqAEeAN9Qpdw",
              authDomain: "sistema-fluxo-caixa-espetinho.firebaseapp.com",
              projectId: "sistema-fluxo-caixa-espetinho",
              storageBucket: "sistema-fluxo-caixa-espetinho.firebasestorage.app",
              messagingSenderId: "628667049442",
              appId: "1:628667049442:web:125e5eb32a3274dcad05bb"
            };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)

        class FluxoCaixa {
            constructor() {
                this.movimentos = []
                this.chart = null
                this.movimentoParaExcluir = null
                this.inicializar()
            }

            inicializar() {
                this.configurarEventos()
                this.carregarDados()
                this.configurarDatasPadrao()
            }

            configurarDatasPadrao() {
                const hoje = new Date()
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1)
                
                // Configura filtros padr√£o para o m√™s atual
                document.getElementById('dataInicio').value = inicioMes.toISOString().split('T')[0]
                document.getElementById('dataFim').value = hoje.toISOString().split('T')[0]
                
                // Configura data atual nos formul√°rios
                document.getElementById('dataReceita').value = hoje.toISOString().split('T')[0]
                document.getElementById('dataDespesa').value = hoje.toISOString().split('T')[0]
            }

            configurarEventos() {
                // Form de receita
                document.getElementById('formReceita').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.adicionarReceita()
                })

                // Form de despesa
                document.getElementById('formDespesa').addEventListener('submit', (e) => {
                    e.preventDefault()
                    this.adicionarDespesa()
                })

                // Per√≠odo padr√£o
                document.getElementById('periodoPadrao').addEventListener('change', (e) => {
                    if (e.target.value) {
                        const dias = parseInt(e.target.value)
                        const hoje = new Date()
                        const inicio = new Date(hoje.getTime() - (dias * 24 * 60 * 60 * 1000))
                        
                        document.getElementById('dataInicio').value = inicio.toISOString().split('T')[0]
                        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0]
                        
                        // Aplicar filtros automaticamente
                        this.atualizarInterface()
                    }
                })

                // Confirma√ß√£o de exclus√£o
                document.getElementById('confirmarExclusaoMovimento').addEventListener('click', () => {
                    this.excluirMovimento()
                })
            }

            async adicionarReceita() {
                const categoria = document.getElementById('categoriaReceita').value
                const valor = parseFloat(document.getElementById('valorReceita').value)
                const dataInput = document.getElementById('dataReceita').value
                const descricao = document.getElementById('descricaoReceita').value

                if (!categoria || !valor || !dataInput) {
                    this.mostrarMensagem('Por favor, preencha todos os campos obrigat√≥rios.', 'warning')
                    return
                }

                // Converter data corretamente
                const dataMovimento = new Date(dataInput + 'T12:00:00.000Z') // Meio-dia UTC para evitar problemas de timezone

                const movimento = {
                    tipo: 'receita',
                    categoria: categoria,
                    valor: valor, // Valor positivo para receitas
                    data: Timestamp.fromDate(dataMovimento),
                    descricao: descricao,
                    timestamp: Timestamp.now()
                }

                try {
                    await addDoc(collection(db, 'movimentos'), movimento)
                    this.limparFormulario('formReceita')
                    this.mostrarMensagem('Receita registrada com sucesso!', 'success')
                } catch (error) {
                    console.error('Erro ao registrar receita:', error)
                    this.mostrarMensagem('Erro ao registrar receita: ' + error.message, 'error')
                }
            }

            async adicionarDespesa() {
                const categoria = document.getElementById('categoriaDespesa').value
                const valor = parseFloat(document.getElementById('valorDespesa').value)
                const dataInput = document.getElementById('dataDespesa').value
                const descricao = document.getElementById('descricaoDespesa').value

                if (!categoria || !valor || !dataInput) {
                    this.mostrarMensagem('Por favor, preencha todos os campos obrigat√≥rios.', 'warning')
                    return
                }

                // Converter data corretamente
                const dataMovimento = new Date(dataInput + 'T12:00:00.000Z') // Meio-dia UTC para evitar problemas de timezone

                const movimento = {
                    tipo: 'despesa',
                    categoria: categoria,
                    valor: -valor, // Valor negativo para despesas
                    data: Timestamp.fromDate(dataMovimento),
                    descricao: descricao,
                    timestamp: Timestamp.now()
                }

                try {
                    await addDoc(collection(db, 'movimentos'), movimento)
                    this.limparFormulario('formDespesa')
                    this.mostrarMensagem('Despesa registrada com sucesso!', 'success')
                } catch (error) {
                    console.error('Erro ao registrar despesa:', error)
                    this.mostrarMensagem('Erro ao registrar despesa: ' + error.message, 'error')
                }
            }

            carregarDados() {
                const q = query(
                    collection(db, 'movimentos'),
                    orderBy('data', 'desc') // Ordenar por data do movimento, n√£o timestamp
                )

                onSnapshot(q, (snapshot) => {
                    this.movimentos = []
                    snapshot.forEach((doc) => {
                        this.movimentos.push({
                            id: doc.id,
                            ...doc.data()
                        })
                    })
                    console.log('Movimentos carregados:', this.movimentos.length)
                    this.atualizarInterface()
                }, (error) => {
                    console.error('Erro ao carregar movimentos:', error)
                    this.mostrarMensagem('Erro ao carregar dados: ' + error.message, 'error')
                })
            }

            atualizarInterface() {
                this.calcularSaldos()
                this.atualizarListaMovimentos()
                this.atualizarGrafico()
            }

            calcularSaldos() {
                const dataInicio = document.getElementById('dataInicio').value
                const dataFim = document.getElementById('dataFim').value
                
                let movimentosFiltrados = this.movimentos

                // Aplicar filtros de data se especificados
                if (dataInicio && dataFim) {
                    const inicio = new Date(dataInicio + 'T00:00:00.000Z')
                    const fim = new Date(dataFim + 'T23:59:59.999Z')

                    movimentosFiltrados = this.movimentos.filter(mov => {
                        const dataMovimento = mov.data.toDate()
                        return dataMovimento >= inicio && dataMovimento <= fim
                    })
                }

                const totalReceitas = movimentosFiltrados
                    .filter(mov => mov.valor > 0)
                    .reduce((total, mov) => total + mov.valor, 0)

                const totalDespesas = Math.abs(movimentosFiltrados
                    .filter(mov => mov.valor < 0)
                    .reduce((total, mov) => total + mov.valor, 0))

                const saldoPeriodo = totalReceitas - totalDespesas
                const saldoTotal = this.movimentos.reduce((total, mov) => total + mov.valor, 0)

                // Atualizar interface
                document.getElementById('totalReceitas').textContent = this.formatarMoeda(totalReceitas)
                document.getElementById('totalDespesas').textContent = this.formatarMoeda(totalDespesas)
                document.getElementById('saldoPeriodo').textContent = this.formatarMoeda(saldoPeriodo)
                document.getElementById('saldoPeriodo').className = saldoPeriodo >= 0 ? 'text-success' : 'text-danger'
                
                const saldoAtualElement = document.getElementById('saldoAtual')
                saldoAtualElement.textContent = this.formatarMoeda(saldoTotal)
                saldoAtualElement.className = saldoTotal >= 0 ? 'saldo-positivo' : 'saldo-negativo'

                console.log('Saldos calculados:', { totalReceitas, totalDespesas, saldoPeriodo, saldoTotal })
            }

            atualizarListaMovimentos() {
                const container = document.getElementById('listaMovimentos')
                const dataInicio = document.getElementById('dataInicio').value
                const dataFim = document.getElementById('dataFim').value
                
                let movimentosFiltrados = this.movimentos

                // Aplicar filtros de data
                if (dataInicio && dataFim) {
                    const inicio = new Date(dataInicio + 'T00:00:00.000Z')
                    const fim = new Date(dataFim + 'T23:59:59.999Z')

                    movimentosFiltrados = this.movimentos.filter(mov => {
                        const dataMovimento = mov.data.toDate()
                        return dataMovimento >= inicio && dataMovimento <= fim
                    })
                }

                if (movimentosFiltrados.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Nenhum movimento encontrado no per√≠odo selecionado.</p>'
                    return
                }

                // Limitar a 100 registros para performance
                const movimentosLimitados = movimentosFiltrados.slice(0, 100)

                let html = `
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Categoria</th>
                                <th>Descri√ß√£o</th>
                                <th class="text-end">Valor</th>
                                <th width="100">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `

                movimentosLimitados.forEach(movimento => {
                    const data = movimento.data.toDate()
                    const tipoClass = movimento.valor > 0 ? 'movimento-receita' : 'movimento-despesa'
                    const tipoIcon = movimento.valor > 0 ? 'üìà' : 'üìâ'
                    const tipoTexto = movimento.valor > 0 ? 'Receita' : 'Despesa'

                    html += `
                        <tr class="${tipoClass}">
                            <td>${data.toLocaleDateString('pt-BR')}</td>
                            <td>${tipoIcon} ${tipoTexto}</td>
                            <td>${movimento.categoria}</td>
                            <td>${movimento.descricao || '-'}</td>
                            <td class="text-end ${movimento.valor >= 0 ? 'text-success' : 'text-danger'}">
                                ${this.formatarMoeda(Math.abs(movimento.valor))}
                            </td>
                            <td>
                                <button class="btn btn-delete" onclick="window.fluxoCaixa.prepararExclusao('${movimento.id}', '${movimento.categoria}', '${this.formatarMoeda(Math.abs(movimento.valor))}')">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `
                })

                html += '</tbody></table>'
                
                if (movimentosFiltrados.length > 100) {
                    html += `<div class="alert alert-info mt-2">
                        <small>Mostrando os 100 registros mais recentes de ${movimentosFiltrados.length} encontrados. Use os filtros para refinar a busca.</small>
                    </div>`
                }

                container.innerHTML = html
            }

            prepararExclusao(id, categoria, valor) {
                this.movimentoParaExcluir = id
                document.getElementById('mensagemExclusao').innerHTML = `
                    <strong>Movimento:</strong> ${categoria}<br>
                    <strong>Valor:</strong> ${valor}<br><br>
                    Tem certeza que deseja excluir este movimento?
                `
                
                const modal = new bootstrap.Modal(document.getElementById('modalConfirmacaoExclusao'))
                modal.show()
            }

            async excluirMovimento() {
                if (!this.movimentoParaExcluir) return

                try {
                    await deleteDoc(doc(db, 'movimentos', this.movimentoParaExcluir))
                    this.mostrarMensagem('Movimento exclu√≠do com sucesso!', 'success')
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacaoExclusao'))
                    modal.hide()
                    
                    this.movimentoParaExcluir = null
                } catch (error) {
                    console.error('Erro ao excluir movimento:', error)
                    this.mostrarMensagem('Erro ao excluir movimento: ' + error.message, 'error')
                }
            }

            atualizarGrafico() {
                const ctx = document.getElementById('graficoFluxo').getContext('2d')
                
                if (this.chart) {
                    this.chart.destroy()
                }

                const dadosGrafico = this.prepararDadosGrafico()

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dadosGrafico.labels,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: dadosGrafico.receitas,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Despesas',
                                data: dadosGrafico.despesas,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Saldo Acumulado',
                                data: dadosGrafico.saldoAcumulado,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': R$ ' + 
                                               context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })
                                    }
                                }
                            }
                        }
                    }
                })
            }

            prepararDadosGrafico() {
                const dataInicio = document.getElementById('dataInicio').value
                const dataFim = document.getElementById('dataFim').value
                
                let movimentosFiltrados = this.movimentos

                // Aplicar filtros de data
                if (dataInicio && dataFim) {
                    const inicio = new Date(dataInicio + 'T00:00:00.000Z')
                    const fim = new Date(dataFim + 'T23:59:59.999Z')

                    movimentosFiltrados = this.movimentos.filter(mov => {
                        const dataMovimento = mov.data.toDate()
                        return dataMovimento >= inicio && dataMovimento <= fim
                    })
                }

                // Agrupa movimentos por dia
                const movimentosPorDia = {}
                
                movimentosFiltrados.forEach(movimento => {
                    const data = movimento.data.toDate().toISOString().split('T')[0]
                    if (!movimentosPorDia[data]) {
                        movimentosPorDia[data] = { receitas: 0, despesas: 0 }
                    }
                    
                    if (movimento.valor > 0) {
                        movimentosPorDia[data].receitas += movimento.valor
                    } else {
                        movimentosPorDia[data].despesas += Math.abs(movimento.valor)
                    }
                })

                // Ordena as datas
                const datasOrdenadas = Object.keys(movimentosPorDia).sort()
                
                const labels = []
                const receitas = []
                const despesas = []
                const saldoAcumulado = []
                let saldoAtual = 0

                datasOrdenadas.forEach(data => {
                    const dataFormatada = new Date(data + 'T12:00:00.000Z').toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    })
                    
                    labels.push(dataFormatada)
                    receitas.push(movimentosPorDia[data].receitas)
                    despesas.push(movimentosPorDia[data].despesas)
                    
                    saldoAtual += movimentosPorDia[data].receitas - movimentosPorDia[data].despesas
                    saldoAcumulado.push(saldoAtual)
                })

                return { labels, receitas, despesas, saldoAcumulado }
            }

            limparFormulario(formId) {
                document.getElementById(formId).reset()
                
                // Restaura a data atual
                const hoje = new Date().toISOString().split('T')[0]
                if (formId === 'formReceita') {
                    document.getElementById('dataReceita').value = hoje
                } else if (formId === 'formDespesa') {
                    document.getElementById('dataDespesa').value = hoje
                }
            }

            formatarMoeda(valor) {
                return 'R$ ' + Math.abs(valor).toLocaleString('pt-BR', { 
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })
            }

            mostrarMensagem(mensagem, tipo) {
                const alertDiv = document.createElement('div')
                alertDiv.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show position-fixed`
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;'
                alertDiv.innerHTML = `
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `
                
                document.body.appendChild(alertDiv)
                
                setTimeout(() => {
                    alertDiv.remove()
                }, 5000)
            }
        }

        // Fun√ß√µes globais
        window.filtrarDados = function() {
            if (window.fluxoCaixa) {
                window.fluxoCaixa.atualizarInterface()
            }
        }

        window.exportarDados = function() {
            if (!window.fluxoCaixa) return
            
            const dataInicio = document.getElementById('dataInicio').value
            const dataFim = document.getElementById('dataFim').value
            
            let movimentosFiltrados = window.fluxoCaixa.movimentos

            // Aplicar filtros de data
            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio + 'T00:00:00.000Z')
                const fim = new Date(dataFim + 'T23:59:59.999Z')

                movimentosFiltrados = window.fluxoCaixa.movimentos.filter(mov => {
                    const dataMovimento = mov.data.toDate()
                    return dataMovimento >= inicio && dataMovimento <= fim
                })
            }
            
            const dados = movimentosFiltrados.map(mov => ({
                Data: mov.data.toDate().toLocaleDateString('pt-BR'),
                Tipo: mov.valor > 0 ? 'Receita' : 'Despesa',
                Categoria: mov.categoria,
                Descri√ß√£o: mov.descricao || '',
                Valor: Math.abs(mov.valor)
            }))

            const csv = [
                ['Data', 'Tipo', 'Categoria', 'Descri√ß√£o', 'Valor'],
                ...dados.map(row => Object.values(row))
            ].map(row => row.join(';')).join('\n')

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
            const link = document.createElement('a')
            link.href = URL.createObjectURL(blob)
            link.download = `fluxo_caixa_${new Date().toISOString().split('T')[0]}.csv`
            link.click()
        }

        // Inicializar sistema
        window.addEventListener('load', () => {
            window.fluxoCaixa = new FluxoCaixa()
        })
    </script>
</body>
</html>
